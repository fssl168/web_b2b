"""
Django settings for server project.

Generated by 'django-admin startproject' using Django 4.1.4.

For more information on this file, see
https://docs.djangoproject.com/en/4.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/4.1/ref/settings/
"""
import os
from pathlib import Path
import environ

# Build paths inside the project like this: BASE_DIR / 'subdir'.
# BASE_DIR = Path(__file__).resolve().parent.parent
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

# 初始化环境变量
env = environ.Env(
    DEBUG=(bool, False),
    ALLOWED_HOSTS=(list, ['127.0.0.1', 'localhost']),
    DB_NAME=(str, 'web_b2b'),
    DB_USER=(str, 'root'),
    DB_PASSWORD=(str, ''),
    DB_HOST=(str, '127.0.0.1'),
    DB_PORT=(str, '3306'),
    SMTP_SERVER=(str, 'smtp.qq.com'),
    SENDER_EMAIL=(str, ''),
    SENDER_PASS=(str, ''),
    ADMIN_ACCESS_PASSWORD=(str, ''),
    ADMIN_ALLOWED_IPS=(list, []),
)

# 读取环境变量文件 - 支持多环境配置
env_mode = os.environ.get('DJANGO_ENV', 'development')
if env_mode == 'production':
    env_file = os.path.join(BASE_DIR, '.env.production')
else:
    env_file = os.path.join(BASE_DIR, '.env.development')
    
environ.Env.read_env(env_file)

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/4.1/howto/deployment/checklist/

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = env('DEBUG')

# SECURITY WARNING: keep the secret key used in production secret!
# 在生产环境强制要求设置自定义密钥
if not DEBUG:
    SECRET_KEY = env('SECRET_KEY')
else:
    # 仅在开发环境使用默认密钥
    SECRET_KEY = env('SECRET_KEY', default='django-insecure-sz@madp0ifx!b)^lg_g!f+5s*w7w_=sjgq-k+erzb%x42$^r!d')

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '%(asctime)s [%(levelname)s] [%(module)s] %(message)s',
            'datefmt': '%Y-%m-%d %H:%M:%S'
        },
        'simple': {
            'format': '%(asctime)s [%(levelname)s] %(message)s',
            'datefmt': '%Y-%m-%d %H:%M:%S'
        },
    },
    'filters': {
        'require_debug_false': {
            '()': 'django.utils.log.RequireDebugFalse',
        },
        'require_debug_true': {
            '()': 'django.utils.log.RequireDebugTrue',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'info.log'),
            'formatter': 'verbose',
        },
        'error_file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'error.log'),
            'formatter': 'verbose',
        },
        'security_file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': os.path.join(BASE_DIR, 'security.log'),
            'formatter': 'verbose',
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'error_file', 'console'],
            'level': 'INFO',
            'propagate': True,
        },
        'django.security': {
            'handlers': ['security_file', 'error_file'],
            'level': 'INFO',
            'propagate': False,
        },
        'django.request': {
            'handlers': ['error_file'],
            'level': 'ERROR',
            'propagate': False,
        },
        'myapp': {
            'handlers': ['file', 'error_file', 'security_file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}


# 直接设置ALLOWED_HOSTS以确保正确解析
# 生产环境请配置具体域名，如: ['example.com', 'www.example.com']
# 开发环境允许所有主机以避免DisallowedHost错误
ALLOWED_HOSTS = ['*']

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',  # 跨域
    'myapp'
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',  # 跨域配置
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',  # CSRF保护
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'myapp.middlewares.LogMiddleware.OpLogs',
    'myapp.middlewares.AdminProtection.AdminProtectionMiddleware',
    'myapp.middlewares.SecurityLogs.SecurityLoggingMiddleware',
]

# 后台防黑保护设置
# 读取ADMIN_ALLOWED_IPS，如果为空字符串或'[]'则设置为空列表
_admin_allowed_ips_raw = env('ADMIN_ALLOWED_IPS', default=[])
if isinstance(_admin_allowed_ips_raw, str):
    if _admin_allowed_ips_raw in ['[]', '', '']:
        ADMIN_ALLOWED_IPS = []
    else:
        ADMIN_ALLOWED_IPS = _admin_allowed_ips_raw.split(',')
elif isinstance(_admin_allowed_ips_raw, list):
    # 如果是列表，检查是否包含空字符串或'[]'
    if len(_admin_allowed_ips_raw) == 1 and _admin_allowed_ips_raw[0] in ['[]', '', '']:
        ADMIN_ALLOWED_IPS = []
    else:
        ADMIN_ALLOWED_IPS = _admin_allowed_ips_raw
else:
    ADMIN_ALLOWED_IPS = []
ADMIN_ACCESS_PASSWORD = env('ADMIN_ACCESS_PASSWORD', default='')  # 后台访问密码，留空则不启用
ADMIN_PASSWORD_EXPIRE_TIME = env('ADMIN_PASSWORD_EXPIRE_TIME', default=3600)  # 访问密码有效期（秒）
ADMIN_PATH_PREFIX = env('ADMIN_PATH_PREFIX', default='admin')  # 后台入口路径前缀

# 安全事件通知设置
SECURITY_EMAIL_NOTIFICATION_ENABLED = env('SECURITY_EMAIL_NOTIFICATION_ENABLED', default=True)  # 是否启用邮件通知

ROOT_URLCONF = 'server.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'server.wsgi.application'

# Database
# https://docs.djangoproject.com/en/4.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': env('DB_NAME'),
        'USER': env('DB_USER'),
        'PASSWORD': env('DB_PASSWORD'),
        'HOST': env('DB_HOST'),
        'PORT': env('DB_PORT'),
        'CONN_MAX_AGE': 60,  # 连接复用时间
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET NAMES 'utf8mb4' COLLATE 'utf8mb4_unicode_ci'",
            'sql_mode': 'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION',
        }
    }
}

# Password validation
# https://docs.djangoproject.com/en/4.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# Internationalization
# https://docs.djangoproject.com/en/4.1/topics/i18n/
LANGUAGE_CODE = 'zh-hans'

# 时区
TIME_ZONE = 'Asia/Shanghai'
USE_I18N = True
USE_L10N = True
USE_TZ = False

# 日期时间格式
DATE_FORMAT = 'Y-m-d'
DATETIME_FORMAT = 'Y-m-d H:i:s'

# 上传文件路径
# 并在urls.py配置+static
MEDIA_ROOT = os.path.join(BASE_DIR, 'upload')
MEDIA_URL = '/upload/'

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.1/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/4.1/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# 跨域配置
CORS_ALLOW_CREDENTIALS = True
CORS_ORIGIN_ALLOW_ALL = False  # 3.x之前写法
CORS_ALLOW_ALL_ORIGINS = False  # 3.3以上写法
CORS_ALLOWED_ORIGINS = [
    'http://localhost:3000',
    'http://127.0.0.1:3000'
]

# 允许的请求头
CORS_ALLOW_HEADERS = [
    'Content-Type',
    'Authorization',
    'ADMINTOKEN',
    'admintoken',
    'X-Requested-With',
]

# 允许的HTTP方法
CORS_ALLOW_METHODS = [
    'GET',
    'POST',
    'PUT',
    'DELETE',
    'OPTIONS',
]

# 缓存配置
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
    }
}


# django上传文件限制 (内存阈值)
FILE_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB

# 图片尺寸
CDN_IMAGE_UPLOAD_SIZE = 10 * 1024 * 2024
# 视频尺寸
CDN_VIDEO_UPLOAD_SIZE = 500 * 1024 * 2024
# 普通文件尺寸
CDN_FILE_UPLOAD_SIZE = 500 * 1024 * 2024

# smtp设置
SMTP_SERVER = env('SMTP_SERVER')
SENDER_EMAIL = env('SENDER_EMAIL')
SENDER_PASS = env('SENDER_PASS')

# 域名
# BASE_HOST_URL = 'http://127.0.0.1:8000'
BASE_HOST_URL = 'http://mytest.com'

# 安全团队配置
SECURITY_TEAM_EMAILS = env('SECURITY_TEAM_EMAILS', default=[])  # 安全团队邮箱列表

# ========================================
# 生产环境安全配置
# ========================================
if not DEBUG:
    # HTTPS 相关配置
    SECURE_SSL_REDIRECT = True
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
    
    # HSTS - 强制使用HTTPS
    SECURE_HSTS_SECONDS = 31536000  # 1年
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
    
    # 安全响应头
    SECURE_CONTENT_TYPE_NOSNIFF = True
    X_FRAME_OPTIONS = 'DENY'
    
    # Cookie 安全配置
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    CSRF_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Strict'
    CSRF_COOKIE_SAMESITE = 'Strict'
    
    # 其他安全配置
    SECURE_BROWSER_XSS_FILTER = True
    SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'
    
    # 内容安全策略（CSP）
    # 注意：需要根据实际情况调整CSP策略
    # SECURE_CONTENT_SECURITY_POLICY = "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:;"
else:
    # 开发环境配置
    SESSION_COOKIE_SECURE = False
    CSRF_COOKIE_SECURE = False
    SESSION_COOKIE_HTTPONLY = True
    CSRF_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    CSRF_COOKIE_SAMESITE = 'Lax'

# REST Framework 配置
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'myapp.auth.authentication.AdminTokenAuthtication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/hour',
        'user': '1000/hour',
    },
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
}

